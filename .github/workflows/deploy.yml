name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  PHP_VERSION: '8.4'

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Node.js dependencies
        run: npm ci

      - name: Build frontend assets
        run: npm run build

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, bcmath, curl, gd, mysql, zip, intl
          coverage: none

      - name: Install Composer dependencies
        run: |
          composer install --optimize-autoloader --no-dev --no-interaction --prefer-dist

      - name: Create deployment package
        run: |
          mkdir -p deploy-package
          # Copy necessary files
          cp -r app bootstrap config database public resources routes storage artisan composer.json composer.lock .env.example deploy-package/
          cp -r public/build deploy-package/public/ 2>/dev/null || true
          # Create .gitkeep for storage directories
          touch deploy-package/storage/.gitkeep
          touch deploy-package/storage/app/.gitkeep
          touch deploy-package/storage/app/public/.gitkeep
          touch deploy-package/storage/framework/.gitkeep
          touch deploy-package/storage/framework/cache/.gitkeep
          touch deploy-package/storage/framework/sessions/.gitkeep
          touch deploy-package/storage/framework/views/.gitkeep
          touch deploy-package/storage/logs/.gitkeep
          # Create deployment script
          cat > deploy-package/deploy.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e
          cd $(dirname "$0")
          
          echo "üöÄ Starting deployment..."
          
          # Fix git ownership if needed (use local config to avoid permission issues)
          if [ -d .git ]; then
            echo "üîß Fixing git ownership..."
            git config --local --add safe.directory $(pwd) 2>/dev/null || true
          fi
          
          # Check PHP version and use PHP 8.4 if available
          if command -v php8.4 &> /dev/null; then
            PHP_CMD="php8.4"
            echo "‚úÖ Using PHP 8.4"
            $PHP_CMD -v
          elif php -v | grep -q "8.4"; then
            PHP_CMD="php"
            echo "‚úÖ Using PHP 8.4 (default)"
            $PHP_CMD -v
          else
            echo "‚ùå ERROR: PHP 8.4 is required but not found!"
            echo "Current PHP version:"
            php -v || echo "PHP not found"
            echo ""
            echo "Please install PHP 8.4 on your server before deploying."
            exit 1
          fi
          
          # Set COMPOSER_ALLOW_SUPERUSER for root execution
          export COMPOSER_ALLOW_SUPERUSER=1
          
          # Install PHP dependencies
          echo "üì¶ Installing PHP dependencies..."
          $PHP_CMD /usr/local/bin/composer install --optimize-autoloader --no-dev --no-interaction || \
          $PHP_CMD $(which composer) install --optimize-autoloader --no-dev --no-interaction || \
          composer install --optimize-autoloader --no-dev --no-interaction
          
          # Set permissions
          echo "üîê Setting permissions..."
          chown -R www-data:www-data .
          chmod -R 755 .
          chmod -R 775 storage bootstrap/cache
          
          # Create storage link if it doesn't exist
          $PHP_CMD artisan storage:link || true
          
          # Run migrations
          echo "üóÑÔ∏è Running migrations..."
          $PHP_CMD artisan migrate --force
          
          # Clear and cache configuration
          echo "‚ö° Optimizing application..."
          $PHP_CMD artisan config:cache
          $PHP_CMD artisan route:cache
          $PHP_CMD artisan view:cache
          
          # Restart queue workers
          echo "üîÑ Restarting queue workers..."
          supervisorctl restart spice-loop-worker:* || echo "‚ö†Ô∏è Queue workers not configured"
          
          # Reload PHP-FPM (try 8.4 first, then fallback)
          echo "üîÑ Reloading PHP-FPM..."
          systemctl reload php8.4-fpm || systemctl reload php8.2-fpm || echo "‚ö†Ô∏è PHP-FPM reload skipped"
          
          echo "‚úÖ Deployment complete!"
          DEPLOY_SCRIPT
          chmod +x deploy-package/deploy.sh

      - name: Create deployment archive
        run: |
          cd deploy-package
          tar -czf ../deployment.tar.gz .
          cd ..

      - name: Copy files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST || secrets.SSH_HOSTNAME || secrets.EC2_HOST }}
          username: ${{ secrets.SSH_USERNAME || secrets.EC2_USER || 'ubuntu' }}
          key: ${{ secrets.SSH_KEY || secrets.EC2_SSH_KEY }}
          port: ${{ secrets.SSH_PORT || secrets.EC2_PORT || 22 }}
          source: "deployment.tar.gz"
          target: "/tmp/"
          strip_components: 0

      - name: Check PHP version on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST || secrets.SSH_HOSTNAME || secrets.EC2_HOST }}
          username: ${{ secrets.SSH_USERNAME || secrets.EC2_USER || 'ubuntu' }}
          key: ${{ secrets.SSH_KEY || secrets.EC2_SSH_KEY }}
          port: ${{ secrets.SSH_PORT || secrets.EC2_PORT || 22 }}
          script: |
            echo "üîç Checking PHP version..."
            if command -v php8.4 &> /dev/null; then
              php8.4 -v
              echo "‚úÖ PHP 8.4 is installed"
            elif php -v | grep -q "8.4"; then
              php -v
              echo "‚úÖ PHP 8.4 is the default version"
            else
              echo "‚ùå PHP 8.4 is NOT installed"
              echo "Current PHP version:"
              php -v || echo "PHP not found"
              echo ""
              echo "‚ö†Ô∏è  Please install PHP 8.4 on your EC2 server:"
              echo "   sudo add-apt-repository -y ppa:ondrej/php"
              echo "   sudo apt-get update"
              echo "   sudo apt-get install -y php8.4-fpm php8.4-cli php8.4-common php8.4-mysql php8.4-zip php8.4-gd php8.4-mbstring php8.4-curl php8.4-xml php8.4-bcmath php8.4-intl"
              echo "   sudo update-alternatives --set php /usr/bin/php8.4"
              exit 1
            fi

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST || secrets.SSH_HOSTNAME || secrets.EC2_HOST }}
          username: ${{ secrets.SSH_USERNAME || secrets.EC2_USER || 'ubuntu' }}
          key: ${{ secrets.SSH_KEY || secrets.EC2_SSH_KEY }}
          port: ${{ secrets.SSH_PORT || secrets.EC2_PORT || 22 }}
          script: |
            set -e
            APP_DIR="${{ secrets.DEPLOY_PATH || secrets.EC2_APP_DIR || '/var/www/spice-loop' }}"
            
            echo "üì¶ Extracting deployment package..."
            cd $APP_DIR
            
            # Backup current .env if it exists
            if [ -f $APP_DIR/.env ]; then
              cp $APP_DIR/.env $APP_DIR/.env.backup
            fi
            
            # Extract new files
            sudo tar -xzf /tmp/deployment.tar.gz -C $APP_DIR --overwrite
            
            # Restore .env if it was backed up
            if [ -f $APP_DIR/.env.backup ]; then
              mv $APP_DIR/.env.backup $APP_DIR/.env
            fi
            
            # Fix ownership of extracted files
            sudo chown -R www-data:www-data $APP_DIR
            
            echo "üîß Running deployment script..."
            sudo -u www-data bash $APP_DIR/deploy.sh || sudo bash $APP_DIR/deploy.sh
            
            echo "üßπ Cleaning up..."
            rm -f /tmp/deployment.tar.gz
            
            echo "‚úÖ Deployment completed successfully!"

