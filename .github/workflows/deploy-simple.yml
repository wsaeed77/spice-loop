name: Deploy to EC2 (Simple - Git Pull)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to EC2 via Git Pull
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script: |
            set -e
            APP_DIR="${{ secrets.EC2_APP_DIR || '/var/www/spice-loop' }}"
            
            echo "ğŸš€ Starting deployment..."
            cd $APP_DIR
            
            # Pull latest code
            echo "ğŸ“¥ Pulling latest code..."
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
            
            # Install PHP dependencies
            echo "ğŸ“¦ Installing PHP dependencies..."
            composer install --optimize-autoloader --no-dev --no-interaction
            
            # Install Node.js dependencies
            echo "ğŸ“¦ Installing Node.js dependencies..."
            npm ci
            
            # Build frontend assets
            echo "ğŸ”¨ Building frontend assets..."
            npm run build
            
            # Set permissions
            echo "ğŸ” Setting permissions..."
            sudo chown -R www-data:www-data $APP_DIR
            sudo chmod -R 755 $APP_DIR
            sudo chmod -R 775 $APP_DIR/storage
            sudo chmod -R 775 $APP_DIR/bootstrap/cache
            
            # Create storage link if it doesn't exist
            php artisan storage:link || true
            
            # Run migrations
            echo "ğŸ—„ï¸ Running migrations..."
            php artisan migrate --force
            
            # Clear and cache configuration
            echo "âš¡ Optimizing application..."
            php artisan config:clear
            php artisan route:clear
            php artisan view:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Restart queue workers
            echo "ğŸ”„ Restarting queue workers..."
            sudo supervisorctl restart spice-loop-worker:* || echo "âš ï¸ Queue workers not configured"
            
            # Reload PHP-FPM
            echo "ğŸ”„ Reloading PHP-FPM..."
            sudo systemctl reload php8.4-fpm || true
            
            echo "âœ… Deployment completed successfully!"

