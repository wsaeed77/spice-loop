name: Deploy to EC2 (Simple - Git Pull)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to EC2 via Git Pull
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST || secrets.SSH_HOSTNAME || secrets.EC2_HOST }}
          username: ${{ secrets.SSH_USERNAME || secrets.EC2_USER || 'ubuntu' }}
          key: ${{ secrets.SSH_KEY || secrets.EC2_SSH_KEY }}
          port: ${{ secrets.SSH_PORT || secrets.EC2_PORT || 22 }}
          script: |
            set -e
            APP_DIR="${{ secrets.DEPLOY_PATH || secrets.EC2_APP_DIR || '/var/www/spice-loop' }}"
            
            echo "üöÄ Starting deployment..."
            cd $APP_DIR
            
            # Fix git ownership if needed
            echo "üîß Fixing git ownership..."
            # Get the current user
            CURRENT_USER=$(whoami)
            # Fix ownership of .git directory and files if they exist
            if [ -d .git ]; then
              echo "   Fixing .git directory ownership..."
              sudo chown -R $CURRENT_USER:$CURRENT_USER .git 2>/dev/null || true
              sudo chmod -R u+rw .git 2>/dev/null || true
              # Also fix ownership of the entire app directory to ensure consistency
              sudo chown -R $CURRENT_USER:$CURRENT_USER $APP_DIR 2>/dev/null || true
            fi
            # Fix git safe directory (both local and global)
            git config --local --add safe.directory $APP_DIR 2>/dev/null || true
            git config --global --add safe.directory $APP_DIR 2>/dev/null || true
            
            # Pull latest code (with proper ownership)
            echo "üì• Pulling latest code..."
            # Ensure we have write access before pulling
            if [ -d .git ]; then
              sudo chown -R $CURRENT_USER:$CURRENT_USER .git
            fi
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
            
            # Check PHP version and use PHP 8.4 if available
            if command -v php8.4 &> /dev/null; then
              PHP_CMD="php8.4"
              echo "‚úÖ Using PHP 8.4"
            elif php -v | grep -q "8.4"; then
              PHP_CMD="php"
              echo "‚úÖ Using PHP 8.4 (default)"
            else
              PHP_CMD="php"
              echo "‚ö†Ô∏è Warning: PHP 8.4 not found, using default PHP"
              php -v
            fi
            
            # Set COMPOSER_ALLOW_SUPERUSER for root execution
            export COMPOSER_ALLOW_SUPERUSER=1
            
            # Install PHP dependencies
            echo "üì¶ Installing PHP dependencies..."
            $PHP_CMD /usr/local/bin/composer install --optimize-autoloader --no-dev --no-interaction || \
            $PHP_CMD $(which composer) install --optimize-autoloader --no-dev --no-interaction || \
            composer install --optimize-autoloader --no-dev --no-interaction
            
            # Install Node.js dependencies
            echo "üì¶ Installing Node.js dependencies..."
            npm ci
            
            # Build frontend assets
            echo "üî® Building frontend assets..."
            npm run build
            
            # Set permissions
            echo "üîê Setting permissions..."
            sudo chown -R www-data:www-data $APP_DIR
            sudo chmod -R 755 $APP_DIR
            sudo chmod -R 775 $APP_DIR/storage
            sudo chmod -R 775 $APP_DIR/bootstrap/cache
            
            # Create storage link if it doesn't exist
            $PHP_CMD artisan storage:link || true
            
            # Run migrations (test connection first)
            echo "üóÑÔ∏è Running migrations..."
            if $PHP_CMD artisan db:show &>/dev/null; then
              $PHP_CMD artisan migrate --force || echo "‚ö†Ô∏è Migration failed - check database credentials"
            else
              echo "‚ö†Ô∏è Cannot connect to database - skipping migrations"
              echo "‚ö†Ô∏è Please configure database credentials in .env file"
            fi
            
            # Clear and cache configuration
            echo "‚ö° Optimizing application..."
            $PHP_CMD artisan config:clear
            $PHP_CMD artisan route:clear
            $PHP_CMD artisan view:clear
            $PHP_CMD artisan config:cache
            $PHP_CMD artisan route:cache
            $PHP_CMD artisan view:cache
            
            # Restart queue workers
            echo "üîÑ Restarting queue workers..."
            sudo supervisorctl restart spice-loop-worker:* || echo "‚ö†Ô∏è Queue workers not configured"
            
            # Reload PHP-FPM
            echo "üîÑ Reloading PHP-FPM..."
            sudo systemctl reload php8.4-fpm || true
            
            echo "‚úÖ Deployment completed successfully!"

